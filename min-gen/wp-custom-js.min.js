const departureSelect=document.getElementById('departure');const arrivalSelect=document.getElementById('arrival');let isFirst=true;const jsonFetch=(url,callback)=>{fetch(url).then(response=>{if(!response.ok){throw new Error('Network response was not ok');}
return response.json();}).then(data=>{callback(data)}).catch(error=>{console.error('There was a problem with the fetch operation:',error);});}
const addTodayText=()=>{let target=document.querySelectorAll("time");if(!target||target.length<=0){return;}
for(let i=0;i<target.length;i++){let row=target[i];if(!row.textContent?.startsWith("최종 업데이트 날짜")&&!row.textContent?.startsWith("Last Updated")){continue;}
if(row.textContent.includes("(오늘)")||row.textContent.includes("(Today)")){continue;}
const today=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Seoul'}));const todayDate=new Date(today.getFullYear(),today.getMonth(),today.getDate());let datePattern,year,month,day;let match=undefined;if(row.textContent.startsWith("최종 업데이트 날짜")){datePattern=/(\d{4})년 (\d{2})월 (\d{2})일/;match=datePattern.exec(row.textContent);if(match){year=parseInt(match[1],10);month=parseInt(match[2],10)-1;day=parseInt(match[3],10);}}
else if(row.textContent.startsWith("Last Updated")){datePattern=/([A-Za-z]+)\s(\d{1,2}),\s(\d{4})/;match=datePattern.exec(row.textContent);if(match){const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];year=parseInt(match[3],10);month=monthNames.indexOf(match[1].substring(0,3));day=parseInt(match[2],10);}}
if(!match||year===undefined||month===undefined||day===undefined){continue;}
const extractedDate=new Date(year,month,day);if(todayDate.getTime()<=extractedDate.getTime()){if(row.textContent.startsWith("최종 업데이트 날짜")){row.innerText+=" (오늘)";}
else if(row.textContent.startsWith("Last Updated")){row.innerText+=" (Today)";}}
break;}}
const tableDuplicateRemove=()=>{const rows=document.querySelectorAll("table tbody tr");const seenRows=new Set();rows.forEach((row)=>{const cells=row.querySelectorAll('td');const cellContents=Array.from(cells).map(cell=>cell.textContent.trim());const rowKey=cellContents.join('|');if(seenRows.has(rowKey)){row.remove();}else{seenRows.add(rowKey);}});}
const tableHighlight=()=>{let ele=document.querySelectorAll("table tbody tr");if(ele&&ele.length>0){const hasClass=(ele,cls)=>{return!!ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));}
try{let localNow=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Seoul'}));let currentHour=localNow.getHours();let currentMinute=localNow.getMinutes();let o=new Date("2020-01-01T"+currentHour.toString().padStart(2,'0')+":"+currentMinute.toString().padStart(2,'0')+":00");for(let i=0;i<ele.length;i++){let row=ele[i];let text=row?.firstElementChild?.textContent;if(text){let[hour,minute]=text.split(':');let e=new Date("2020-01-01T"+hour.toString().padStart(2,'0')+":"+minute.toString().padStart(2,'0')+":00");if(o<e){if(!hasClass(row,"table-success")){row.className+=" table-success";}
break;}}}}
catch(e){}}}
async function loadDepartureData(){try{const response=await fetch('/wp-content/json/all.json');const jsonData=await response.json();jsonData.forEach(departure=>{const option=document.createElement('option');option.value=departure;option.textContent=departure;departureSelect.appendChild(option);});const defaultDeparture=data?.depature;if(jsonData.includes(defaultDeparture)){departureSelect.value=defaultDeparture;loadArrivalData();}
departureSelect.addEventListener('change',loadArrivalData);}catch(error){console.error('출발지 데이터 로드 실패:',error);}}
function createArrivals(){fetch('/wp-content/json/main.json').then(res=>res.json()).then(innerData=>{const depatureKey=data.depature;if(!depatureKey){console.log('empty depatureKey')
return;}
const arrivals=innerData?.[depatureKey];if(!arrivals){console.log('empty arrivals')
return;}
const fragment=document.createDocumentFragment();const h2=document.createElement('h2');h2.textContent=depatureKey+"의 다른 도착지";fragment.appendChild(h2);Object.keys(arrivals).sort((a,b)=>a.localeCompare(b,'ko')).forEach(arr=>{const aTag=document.createElement('a');aTag.href=arrivals[arr].url;aTag.textContent=arr;aTag.className="rounded-link";aTag.setAttribute("style","margin:0.2rem");fragment.appendChild(aTag);});const targetDiv=document.querySelector('div.yarpp.yarpp-related.yarpp-related-website.yarpp-template-list');if(targetDiv){targetDiv.parentNode.insertBefore(fragment,targetDiv);}}).catch(err=>console.error('JSON 로딩 실패:',err));}
async function loadArrivalData(){const departure=departureSelect.value;if(!departure){arrivalSelect.innerHTML='<option value="">도착지를 선택하세요</option>';arrivalSelect.disabled=true;return;}
try{const response=await fetch('/wp-content/json/main.json');const jsonData=await response.json();const arrivals=jsonData?.[departure];if(!arrivals){console.log('해당 출발지의 도착지 데이터 없음:',departure);arrivalSelect.innerHTML='<option value="">도착지를 선택하세요</option>';arrivalSelect.disabled=true;return;}
arrivalSelect.innerHTML='<option value="">도착지를 선택하세요</option>';let targetArr=[];let isArray=false;if(Array.isArray(arrivals)){targetArr=arrivals;isArray=true;}else{targetArr=Object.keys(arrivals);}
targetArr.forEach(arrival=>{const option=document.createElement('option');option.value=arrival;option.textContent=arrival;arrivalSelect.appendChild(option);});if(isFirst){const links=document.getElementById('links');if(links){let newHTML=[];if(isArray){arrivals.forEach(arrival=>{newHTML.push('<a href="#" class="rounded-link" style="margin:0.2rem" data-departure="'+departure+'">'+arrival+'</a>');});}else{const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Seoul'}));const currentHours=now.getHours();const currentMinutes=now.getMinutes();Object.keys(arrivals).forEach((key)=>{let value=arrivals[key];let isWorking=false;let arrival=key;if(value&&'hours'in value&&value.hours){const[targetHours,targetMinutes]=value.hours.split(':').map(Number);if(currentHours<targetHours||(currentHours===targetHours&&currentMinutes<targetMinutes)){isWorking=true;}}
let classz=isWorking?'primary-link':'rounded-link';newHTML.push('<a href="#" class="'+classz+'" style="margin:0.2rem" data-departure="'+departure+'">'+arrival+'</a>');});}
links.innerHTML=newHTML.join('');links.querySelectorAll('.rounded-link, .primary-link').forEach(link=>{link.addEventListener('click',async(event)=>{event.preventDefault();const dep=link.dataset.departure;const arr=link.textContent;const response=await fetch('/wp-content/json/'+dep+'/'+arr+'/all.json');const data=await response.json();if(data.url){window.location.href=data.url;}});});}
isFirst=false;}
arrivalSelect.disabled=false;arrivalSelect.addEventListener('change',handleArrivalChange);}catch(error){console.error('도착지 데이터 로드 실패:',error);}}
async function handleArrivalChange(){const departure=departureSelect.value;const arrival=arrivalSelect.value;if(!arrival)return;try{const response=await fetch('/wp-content/json/'+departure+'/'+arrival+'/all.json');const data=await response.json();if(data.url){window.location.href=data.url;}}catch(error){console.error('도착지 URL 로드 실패:',error);}}
document.addEventListener("DOMContentLoaded",function(){const shareBtn=document.getElementById('share-btn');if(shareBtn){shareBtn.addEventListener('click',function(){const url=window.location.href;if(navigator.share){navigator.share({url:url}).then(()=>{console.log('공유 성공');}).catch((error)=>{console.error('공유 실패:',error);});}
else{navigator.clipboard.writeText(url).then(()=>{alert('URL이 클립보드에 복사되었습니다.');}).catch((error)=>{console.error('클립보드 복사 실패:',error);alert('URL 복사 실패. 수동으로 복사해 주세요.');});}});}
if(window.location.pathname.startsWith("/station")||window.location.pathname.startsWith("/timetable")){addTodayText();tableDuplicateRemove();tableHighlight();}
if(window.location.pathname.startsWith("/timetable")){const departureSelect=document.getElementById('departure');const arrivalSelect=document.getElementById('arrival');if(departureSelect&&arrivalSelect){loadDepartureData();}
else{createArrivals()}}});